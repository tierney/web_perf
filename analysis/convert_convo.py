#!/usr/bin/env python

convo_a = '''25	74	5.178600000	192.168.42.196	38829	74.125.65.93	80	1	0
32	66	5.533309000	74.125.65.93	80	192.168.42.196	38829	1	1
33	54	5.533374000	192.168.42.196	38829	74.125.65.93	80	0	1
34	351	5.533580000	192.168.42.196	38829	74.125.65.93	80	0	1	http://www.youtube.com/
37	54	5.874572000	74.125.65.93	80	192.168.42.196	38829	0	1
39	54	6.623299000	74.125.65.93	80	192.168.42.196	38829	0	1
40	1314	8.002547000	74.125.65.93	80	192.168.42.196	38829	0	1
41	54	8.002588000	192.168.42.196	38829	74.125.65.93	80	0	1
42	1314	8.011734000	74.125.65.93	80	192.168.42.196	38829	0	1
43	54	8.011783000	192.168.42.196	38829	74.125.65.93	80	0	1
44	782	8.011849000	74.125.65.93	80	192.168.42.196	38829	0	1
45	54	8.011865000	192.168.42.196	38829	74.125.65.93	80	0	1
46	1185	8.011877000	74.125.65.93	80	192.168.42.196	38829	0	1
47	54	8.011889000	192.168.42.196	38829	74.125.65.93	80	0	1
48	1166	8.011899000	74.125.65.93	80	192.168.42.196	38829	0	1
49	54	8.011908000	192.168.42.196	38829	74.125.65.93	80	0	1
50	863	8.020482000	74.125.65.93	80	192.168.42.196	38829	0	1
51	54	8.020502000	192.168.42.196	38829	74.125.65.93	80	0	1
52	799	8.020510000	74.125.65.93	80	192.168.42.196	38829	0	1
53	54	8.020512000	192.168.42.196	38829	74.125.65.93	80	0	1
54	682	8.020515000	74.125.65.93	80	192.168.42.196	38829	0	1
55	54	8.020517000	192.168.42.196	38829	74.125.65.93	80	0	1
56	911	8.020519000	74.125.65.93	80	192.168.42.196	38829	0	1
57	54	8.020521000	192.168.42.196	38829	74.125.65.93	80	0	1
59	691	8.031074000	74.125.65.93	80	192.168.42.196	38829	0	1
60	756	8.031098000	74.125.65.93	80	192.168.42.196	38829	0	1
61	54	8.031102000	192.168.42.196	38829	74.125.65.93	80	0	1
62	54	8.031111000	192.168.42.196	38829	74.125.65.93	80	0	1
63	782	8.031212000	74.125.65.93	80	192.168.42.196	38829	0	1
64	54	8.031220000	192.168.42.196	38829	74.125.65.93	80	0	1
65	806	8.031225000	74.125.65.93	80	192.168.42.196	38829	0	1
66	54	8.031229000	192.168.42.196	38829	74.125.65.93	80	0	1
67	721	8.031232000	74.125.65.93	80	192.168.42.196	38829	0	1
68	54	8.031235000	192.168.42.196	38829	74.125.65.93	80	0	1
69	787	8.039857000	74.125.65.93	80	192.168.42.196	38829	0	1
70	54	8.039887000	192.168.42.196	38829	74.125.65.93	80	0	1
71	1314	8.049991000	74.125.65.93	80	192.168.42.196	38829	0	1
72	54	8.050007000	192.168.42.196	38829	74.125.65.93	80	0	1
73	598	8.050028000	74.125.65.93	80	192.168.42.196	38829	0	1
74	54	8.050041000	192.168.42.196	38829	74.125.65.93	80	0	1
75	1314	8.122910000	74.125.65.93	80	192.168.42.196	38829	0	1
76	54	8.122952000	192.168.42.196	38829	74.125.65.93	80	0	1
77	1314	8.122972000	74.125.65.93	80	192.168.42.196	38829	0	1
78	54	8.122979000	192.168.42.196	38829	74.125.65.93	80	0	1
79	1204	8.130233000	74.125.65.93	80	192.168.42.196	38829	0	1		200
80	54	8.130265000	192.168.42.196	38829	74.125.65.93	80	0	1
908	54	13.707514000	192.168.42.196	38829	74.125.65.93	80	0	1'''

convo_b = '''32	74	3.175885000	192.168.42.196	44778	176.32.75.29	80	1	0
43	66	3.360020000	176.32.75.29	80	192.168.42.196	44778	1	1
44	54	3.360063000	192.168.42.196	44778	176.32.75.29	80	0	1
47	491	3.360421000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/00_003_7175.jpg
54	54	3.501434000	176.32.75.29	80	192.168.42.196	44778	0	1
61	54	3.649760000	176.32.75.29	80	192.168.42.196	44778	0	1
118	1314	4.251897000	176.32.75.29	80	192.168.42.196	44778	0	1
119	54	4.251934000	192.168.42.196	44778	176.32.75.29	80	0	1
120	1314	4.251951000	176.32.75.29	80	192.168.42.196	44778	0	1
121	54	4.251958000	192.168.42.196	44778	176.32.75.29	80	0	1
122	1314	4.251964000	176.32.75.29	80	192.168.42.196	44778	0	1
123	54	4.251974000	192.168.42.196	44778	176.32.75.29	80	0	1
124	1314	4.260022000	176.32.75.29	80	192.168.42.196	44778	0	1
125	54	4.260064000	192.168.42.196	44778	176.32.75.29	80	0	1
126	940	4.260084000	176.32.75.29	80	192.168.42.196	44778	0	1		200
127	54	4.260090000	192.168.42.196	44778	176.32.75.29	80	0	1
128	491	4.261150000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/01_000_7218.jpg
159	54	4.501578000	176.32.75.29	80	192.168.42.196	44778	0	1
169	1314	4.641910000	176.32.75.29	80	192.168.42.196	44778	0	1
170	1314	4.641966000	176.32.75.29	80	192.168.42.196	44778	0	1
171	54	4.641982000	192.168.42.196	44778	176.32.75.29	80	0	1
172	1314	4.642000000	176.32.75.29	80	192.168.42.196	44778	0	1
173	1314	4.642005000	176.32.75.29	80	192.168.42.196	44778	0	1
174	54	4.642010000	192.168.42.196	44778	176.32.75.29	80	0	1
175	957	4.642077000	176.32.75.29	80	192.168.42.196	44778	0	1		200
176	491	4.644165000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/01_005_7229.jpg
215	54	4.851451000	176.32.75.29	80	192.168.42.196	44778	0	1
217	1314	5.021783000	176.32.75.29	80	192.168.42.196	44778	0	1
218	1314	5.031504000	176.32.75.29	80	192.168.42.196	44778	0	1
219	54	5.031539000	192.168.42.196	44778	176.32.75.29	80	0	1
220	1314	5.031574000	176.32.75.29	80	192.168.42.196	44778	0	1
221	1314	5.031586000	176.32.75.29	80	192.168.42.196	44778	0	1
222	54	5.031596000	192.168.42.196	44778	176.32.75.29	80	0	1
223	977	5.031602000	176.32.75.29	80	192.168.42.196	44778	0	1		200
224	491	5.032627000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/02_000_7223.jpg
264	54	5.299762000	176.32.75.29	80	192.168.42.196	44778	0	1
266	1314	5.433375000	176.32.75.29	80	192.168.42.196	44778	0	1
267	1314	5.433407000	176.32.75.29	80	192.168.42.196	44778	0	1
268	54	5.433421000	192.168.42.196	44778	176.32.75.29	80	0	1
269	1314	5.451118000	176.32.75.29	80	192.168.42.196	44778	0	1
270	1314	5.451148000	176.32.75.29	80	192.168.42.196	44778	0	1
271	54	5.451161000	192.168.42.196	44778	176.32.75.29	80	0	1
272	911	5.451207000	176.32.75.29	80	192.168.42.196	44778	0	1		200
277	491	5.452200000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/02_006_7265.jpg
318	54	5.689769000	176.32.75.29	80	192.168.42.196	44778	0	1
324	1314	5.831878000	176.32.75.29	80	192.168.42.196	44778	0	1
325	1314	5.831912000	176.32.75.29	80	192.168.42.196	44778	0	1
326	54	5.831942000	192.168.42.196	44778	176.32.75.29	80	0	1
327	1314	5.831956000	176.32.75.29	80	192.168.42.196	44778	0	1
328	1314	5.831967000	176.32.75.29	80	192.168.42.196	44778	0	1
329	1002	5.832061000	176.32.75.29	80	192.168.42.196	44778	0	1		200
330	54	5.832137000	192.168.42.196	44778	176.32.75.29	80	0	1
331	491	5.834274000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/03_002_7173.jpg
374	54	6.049741000	176.32.75.29	80	192.168.42.196	44778	0	1
391	1314	6.211989000	176.32.75.29	80	192.168.42.196	44778	0	1
392	1314	6.212021000	176.32.75.29	80	192.168.42.196	44778	0	1
393	1314	6.212030000	176.32.75.29	80	192.168.42.196	44778	0	1
394	1314	6.212074000	176.32.75.29	80	192.168.42.196	44778	0	1
395	922	6.212080000	176.32.75.29	80	192.168.42.196	44778	0	1		200
397	54	6.212086000	192.168.42.196	44778	176.32.75.29	80	0	1
398	54	6.213283000	192.168.42.196	44778	176.32.75.29	80	0	1
399	491	6.214172000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/03_009_7210.jpg
443	54	6.449858000	176.32.75.29	80	192.168.42.196	44778	0	1
488	1314	6.675360000	176.32.75.29	80	192.168.42.196	44778	0	1
489	1314	6.675389000	176.32.75.29	80	192.168.42.196	44778	0	1
490	1314	6.675398000	176.32.75.29	80	192.168.42.196	44778	0	1
491	1314	6.675432000	176.32.75.29	80	192.168.42.196	44778	0	1
492	946	6.675438000	176.32.75.29	80	192.168.42.196	44778	0	1		200
493	54	6.675453000	192.168.42.196	44778	176.32.75.29	80	0	1
494	54	6.676574000	192.168.42.196	44778	176.32.75.29	80	0	1
495	491	6.677424000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/04_009_7166.jpg
507	54	6.899907000	176.32.75.29	80	192.168.42.196	44778	0	1
540	1314	7.052753000	176.32.75.29	80	192.168.42.196	44778	0	1
541	1314	7.052803000	176.32.75.29	80	192.168.42.196	44778	0	1
542	1314	7.052809000	176.32.75.29	80	192.168.42.196	44778	0	1
543	1314	7.052817000	176.32.75.29	80	192.168.42.196	44778	0	1
544	929	7.052824000	176.32.75.29	80	192.168.42.196	44778	0	1		200
545	54	7.053031000	192.168.42.196	44778	176.32.75.29	80	0	1
546	491	7.056291000	192.168.42.196	44778	176.32.75.29	80	0	1	http://ec2-176-32-75-29.ap-northeast-1.compute.amazonaws.com/05_005_7215.jpg
561	54	7.309592000	176.32.75.29	80	192.168.42.196	44778	0	1
592	1314	7.430963000	176.32.75.29	80	192.168.42.196	44778	0	1
593	1314	7.430994000	176.32.75.29	80	192.168.42.196	44778	0	1
594	1314	7.431038000	176.32.75.29	80	192.168.42.196	44778	0	1
595	54	7.431145000	192.168.42.196	44778	176.32.75.29	80	0	1
596	1314	7.440346000	176.32.75.29	80	192.168.42.196	44778	0	1
597	954	7.440376000	176.32.75.29	80	192.168.42.196	44778	0	1		200
598	54	7.440502000	192.168.42.196	44778	176.32.75.29	80	0	1
640	54	8.189376000	192.168.42.196	44778	176.32.75.29	80	0	1
646	54	8.321917000	176.32.75.29	80	192.168.42.196	44778	0	1
652	54	8.322014000	176.32.75.29	80	192.168.42.196	44778	0	1
653	54	8.322033000	192.168.42.196	44778	176.32.75.29	80	0	1'''

class TcpLine(object):
  def __init__(self, frame_num, size, timestamp, src_ip, src_port, dst_ip,
               dst_port, syn, ack, req_uri = None, resp_code = None):
    self.frame_num = frame_num
    self.size = int(size)
    self.timestamp = timestamp
    self.src_ip = src_ip
    self.src_port = src_port
    self.dst_ip = dst_ip
    self.dst_port = dst_port
    self.syn = bool(int(syn))
    self.ack = bool(int(ack))
    self.req_uri = req_uri
    self.resp_code = resp_code

class ConversationConverter(object):
  def convert(self, convo):
    output = ''
    SYN_ACK = False
    REQ_ACK = False

    convo_name = ''
    for line in convo.split('\n'):
      split_line = line.split('\t')
      tcp_line = TcpLine(*split_line)

      # SYN
      if tcp_line.syn and not tcp_line.ack:
        source_ip = tcp_line.src_ip
        convo_name = '%s<->%s:%s' % (tcp_line.src_port,
                                     tcp_line.dst_ip, tcp_line.dst_port)
        SYN_ACK = True
        output += '%s\t%s\t' % (convo_name, tcp_line.timestamp)
        # print convo_name, tcp_line.timestamp,
        continue

      # SYNACK
      if SYN_ACK:
        output += '%s\t%s\n' % (tcp_line.timestamp, 'SYNACK')
        # print tcp_line.timestamp, 'SYNACK'
        SYN_ACK = False
        continue

      # REQUEST
      if tcp_line.req_uri:
        REQ_ACK = True
        output += '%s\t%s\t' % (convo_name, tcp_line.timestamp)
        # print convo_name, tcp_line.timestamp,
        continue
      if REQ_ACK:
        if tcp_line.size <= 54:
          fake_intermediate = '%s\t%s\t%s\t%s' % \
              (convo_name, tcp_line.timestamp, tcp_line.timestamp, 'ACK')
          continue
        output += '%s\t%s\n' % (tcp_line.timestamp, 'GET')
        output += '%s\n' % (fake_intermediate)
        # print tcp_line.timestamp, 'GET'
        # print fake_intermediate
        REQ_ACK = False
        continue

      if tcp_line.resp_code:
        output += '%s\t%s\t%s\t%s\n' % (
          convo_name, tcp_line.timestamp, tcp_line.timestamp, 'RESP')
        # print convo_name, tcp_line.timestamp, tcp_line.timestamp, 'RESP'
        continue

      if tcp_line.src_ip == source_ip:
        comment = 'ACK'
      else:
        comment = 'RESP'
      output += '%s\t%s\t%s\t%s\n' % (
        convo_name, tcp_line.timestamp, tcp_line.timestamp, comment)
      # print convo_name, tcp_line.timestamp, tcp_line.timestamp, comment
    return output

print ConversationConverter().convert(convo_a)
print ConversationConverter().convert(convo_b)
