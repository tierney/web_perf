"""
Light Pink - DNS
Dark Pink - DNS
Blue - GET (outgoing)
Green - response (incoming)
Light Gray - ACK
Dark Gray - SYNACK
Red - Retransmission

"""
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.dates import DateFormatter, MinuteLocator, SecondLocator
import numpy as np
from StringIO import StringIO
import datetime as dt
matplotlib.rcParams['ytick.labelsize'] = 'x-small'

a = StringIO("""
Convo 8.163473000	8.260164000	SYNACK
Convo 8.260488000	8.360089000	GET
Convo 8.434873000 8.434873000	RESP
Convo 8.434915000 8.434915000	ACK
Convo 8.434933000	8.434933000 RESP
Convo 8.434941000 8.434941000	ACK
Convo 12.473271000 12.761878000	GET
Convo 12.761895000	12.761895000 ACK
Convo 12.775673000	12.775673000 RESP
Convo 12.775692000	12.775692000 ACK
Convo 12.784929000	12.784929000 RESP
Convo 12.784933000	12.784933000 ACK
Convo 13.707613000	13.707613000 ACK
""")

a = StringIO("""
38829<->74.125.65.93:80	5.178600000	5.533309000	SYNACK
38829<->74.125.65.93:80	5.533374000	5.533374000	ACK
38829<->74.125.65.93:80	5.533580000	8.002547000	GET
38829<->74.125.65.93:80	6.623299000	6.623299000	ACK
38829<->74.125.65.93:80	8.002588000	8.002588000	ACK
38829<->74.125.65.93:80	8.011734000	8.011734000	RESP
38829<->74.125.65.93:80	8.011783000	8.011783000	ACK
38829<->74.125.65.93:80	8.011849000	8.011849000	RESP
38829<->74.125.65.93:80	8.011865000	8.011865000	ACK
38829<->74.125.65.93:80	8.011877000	8.011877000	RESP
38829<->74.125.65.93:80	8.011889000	8.011889000	ACK
38829<->74.125.65.93:80	8.011899000	8.011899000	RESP
38829<->74.125.65.93:80	8.011908000	8.011908000	ACK
38829<->74.125.65.93:80	8.020482000	8.020482000	RESP
38829<->74.125.65.93:80	8.020502000	8.020502000	ACK
38829<->74.125.65.93:80	8.020510000	8.020510000	RESP
38829<->74.125.65.93:80	8.020512000	8.020512000	ACK
38829<->74.125.65.93:80	8.020515000	8.020515000	RESP
38829<->74.125.65.93:80	8.020517000	8.020517000	ACK
38829<->74.125.65.93:80	8.020519000	8.020519000	RESP
38829<->74.125.65.93:80	8.020521000	8.020521000	ACK
38829<->74.125.65.93:80	8.031074000	8.031074000	RESP
38829<->74.125.65.93:80	8.031098000	8.031098000	RESP
38829<->74.125.65.93:80	8.031102000	8.031102000	ACK
38829<->74.125.65.93:80	8.031111000	8.031111000	ACK
38829<->74.125.65.93:80	8.031212000	8.031212000	RESP
38829<->74.125.65.93:80	8.031220000	8.031220000	ACK
38829<->74.125.65.93:80	8.031225000	8.031225000	RESP
38829<->74.125.65.93:80	8.031229000	8.031229000	ACK
38829<->74.125.65.93:80	8.031232000	8.031232000	RESP
38829<->74.125.65.93:80	8.031235000	8.031235000	ACK
38829<->74.125.65.93:80	8.039857000	8.039857000	RESP
38829<->74.125.65.93:80	8.039887000	8.039887000	ACK
38829<->74.125.65.93:80	8.049991000	8.049991000	RESP
38829<->74.125.65.93:80	8.050007000	8.050007000	ACK
38829<->74.125.65.93:80	8.050028000	8.050028000	RESP
38829<->74.125.65.93:80	8.050041000	8.050041000	ACK
38829<->74.125.65.93:80	8.122910000	8.122910000	RESP
38829<->74.125.65.93:80	8.122952000	8.122952000	ACK
38829<->74.125.65.93:80	8.122972000	8.122972000	RESP
38829<->74.125.65.93:80	8.122979000	8.122979000	ACK
38829<->74.125.65.93:80	8.130233000	8.130233000	RESP
38829<->74.125.65.93:80	8.130265000	8.130265000	ACK
38829<->74.125.65.93:80	13.707514000	13.707514000	ACK

44778<->176.32.75.29:80	3.175885000	3.360020000	SYNACK
44778<->176.32.75.29:80	3.360063000	3.360063000	ACK
44778<->176.32.75.29:80	3.360421000	4.251897000	GET
44778<->176.32.75.29:80	3.649760000	3.649760000	ACK
44778<->176.32.75.29:80	4.251934000	4.251934000	ACK
44778<->176.32.75.29:80	4.251951000	4.251951000	RESP
44778<->176.32.75.29:80	4.251958000	4.251958000	ACK
44778<->176.32.75.29:80	4.251964000	4.251964000	RESP
44778<->176.32.75.29:80	4.251974000	4.251974000	ACK
44778<->176.32.75.29:80	4.260022000	4.260022000	RESP
44778<->176.32.75.29:80	4.260064000	4.260064000	ACK
44778<->176.32.75.29:80	4.260084000	4.260084000	RESP
44778<->176.32.75.29:80	4.260090000	4.260090000	ACK
44778<->176.32.75.29:80	4.261150000	4.641910000	GET
44778<->176.32.75.29:80	4.501578000	4.501578000	ACK
44778<->176.32.75.29:80	4.641966000	4.641966000	RESP
44778<->176.32.75.29:80	4.641982000	4.641982000	ACK
44778<->176.32.75.29:80	4.642000000	4.642000000	RESP
44778<->176.32.75.29:80	4.642005000	4.642005000	RESP
44778<->176.32.75.29:80	4.642010000	4.642010000	ACK
44778<->176.32.75.29:80	4.642077000	4.642077000	RESP
44778<->176.32.75.29:80	4.644165000	5.021783000	GET
44778<->176.32.75.29:80	4.851451000	4.851451000	ACK
44778<->176.32.75.29:80	5.031504000	5.031504000	RESP
44778<->176.32.75.29:80	5.031539000	5.031539000	ACK
44778<->176.32.75.29:80	5.031574000	5.031574000	RESP
44778<->176.32.75.29:80	5.031586000	5.031586000	RESP
44778<->176.32.75.29:80	5.031596000	5.031596000	ACK
44778<->176.32.75.29:80	5.031602000	5.031602000	RESP
44778<->176.32.75.29:80	5.032627000	5.433375000	GET
44778<->176.32.75.29:80	5.299762000	5.299762000	ACK
44778<->176.32.75.29:80	5.433407000	5.433407000	RESP
44778<->176.32.75.29:80	5.433421000	5.433421000	ACK
44778<->176.32.75.29:80	5.451118000	5.451118000	RESP
44778<->176.32.75.29:80	5.451148000	5.451148000	RESP
44778<->176.32.75.29:80	5.451161000	5.451161000	ACK
44778<->176.32.75.29:80	5.451207000	5.451207000	RESP
44778<->176.32.75.29:80	5.452200000	5.831878000	GET
44778<->176.32.75.29:80	5.689769000	5.689769000	ACK
44778<->176.32.75.29:80	5.831912000	5.831912000	RESP
44778<->176.32.75.29:80	5.831942000	5.831942000	ACK
44778<->176.32.75.29:80	5.831956000	5.831956000	RESP
44778<->176.32.75.29:80	5.831967000	5.831967000	RESP
44778<->176.32.75.29:80	5.832061000	5.832061000	RESP
44778<->176.32.75.29:80	5.832137000	5.832137000	ACK
44778<->176.32.75.29:80	5.834274000	6.211989000	GET
44778<->176.32.75.29:80	6.049741000	6.049741000	ACK
44778<->176.32.75.29:80	6.212021000	6.212021000	RESP
44778<->176.32.75.29:80	6.212030000	6.212030000	RESP
44778<->176.32.75.29:80	6.212074000	6.212074000	RESP
44778<->176.32.75.29:80	6.212080000	6.212080000	RESP
44778<->176.32.75.29:80	6.212086000	6.212086000	ACK
44778<->176.32.75.29:80	6.213283000	6.213283000	ACK
44778<->176.32.75.29:80	6.214172000	6.675360000	GET
44778<->176.32.75.29:80	6.449858000	6.449858000	ACK
44778<->176.32.75.29:80	6.675389000	6.675389000	RESP
44778<->176.32.75.29:80	6.675398000	6.675398000	RESP
44778<->176.32.75.29:80	6.675432000	6.675432000	RESP
44778<->176.32.75.29:80	6.675438000	6.675438000	RESP
44778<->176.32.75.29:80	6.675453000	6.675453000	ACK
44778<->176.32.75.29:80	6.676574000	6.676574000	ACK
44778<->176.32.75.29:80	6.677424000	7.052753000	GET
44778<->176.32.75.29:80	6.899907000	6.899907000	ACK
44778<->176.32.75.29:80	7.052803000	7.052803000	RESP
44778<->176.32.75.29:80	7.052809000	7.052809000	RESP
44778<->176.32.75.29:80	7.052817000	7.052817000	RESP
44778<->176.32.75.29:80	7.052824000	7.052824000	RESP
44778<->176.32.75.29:80	7.053031000	7.053031000	ACK
44778<->176.32.75.29:80	7.056291000	7.430963000	GET
44778<->176.32.75.29:80	7.309592000	7.309592000	ACK
44778<->176.32.75.29:80	7.430994000	7.430994000	RESP
44778<->176.32.75.29:80	7.431038000	7.431038000	RESP
44778<->176.32.75.29:80	7.431145000	7.431145000	ACK
44778<->176.32.75.29:80	7.440346000	7.440346000	RESP
44778<->176.32.75.29:80	7.440376000	7.440376000	RESP
44778<->176.32.75.29:80	7.440502000	7.440502000	ACK
44778<->176.32.75.29:80	8.189376000	8.189376000	ACK
44778<->176.32.75.29:80	8.321917000	8.321917000	RESP
44778<->176.32.75.29:80	8.322014000	8.322014000	RESP
44778<->176.32.75.29:80	8.322033000	8.322033000	ACK
""")

data=np.genfromtxt(a, converters={1: float,2: float},
                   names=['caption','start','stop','state'], dtype=None)
cap, start, stop=data['caption'], data['start'], data['stop']
print cap, start, stop

synack = (data['state'] == 'SYNACK')
get = (data['state'] == 'GET')
resp = (data['state'] == 'RESP')
ack = (data['state'] == 'ACK')

print ack
captions, unique_idx, caption_inv = np.unique(cap, 1,1)
print captions, unique_idx, caption_inv

y=(caption_inv+1)/float(len(captions)+1)

def timelines(y, xstart, xstop,color='b'):
  """Plot timelines at y from xstart to xstop with given color."""
  plt.hlines(y,xstart,xstop,color, lw=4)
  plt.vlines(xstart, y+0.03,y-0.03, color,lw=1)
  plt.vlines(xstop, y+0.03,y-0.03,color, lw=1)

timelines(y[synack],start[synack],stop[synack],'black')
timelines(y[get],start[get],stop[get],'blue')
timelines(y[resp],start[resp],stop[resp],'green')
timelines(y[ack],start[ack],stop[ack],'red')

#Setup the plot
ax=plt.gca()
delta=(stop.max()-start.min()) / 10

plt.yticks(y[unique_idx], captions)
plt.ylim(0,1)
plt.xlim(start.min() - delta, stop.max() + delta)
plt.xlabel('Time')
plt.savefig('Test.png', bbox_inches='tight')
print 'Done'
